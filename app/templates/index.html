<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ß–∞—Ç-–±–æ—Ç</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --primary-hover: #3367d6;
            --sidebar-bg: #f8f9fa;
            --chat-bg: #ffffff;
            --user-msg-bg: #e3f2fd;
            --bot-msg-bg: #f1f3f4;
            --text-color: #202124;
            --border-color: #dadce0;
            --spacing: 16px;
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            color: var(--text-color);
            line-height: 1.5;
        }

        #sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            padding: var(--spacing);
            overflow: auto;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        #sidebar-header {
            padding-bottom: var(--spacing);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing);
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
        }

        #chat-header {
            padding: var(--spacing);
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
            font-weight: 500;
        }

        #chat-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
        }

        #message-box {
            padding: var(--spacing);
            border-top: 1px solid var(--border-color);
            background: var(--sidebar-bg);
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 16px;
            outline: none;
            transition: border 0.2s;
        }

        input:focus {
            border-color: var(--primary-color);
        }

        button {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button.secondary {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
        }

        button.secondary:hover {
            background: #f1f3f4;
        }

        #chat-list {
            list-style: none;
            flex: 1;
            overflow-y: auto;
        }

        #chat-list li {
            padding: 12px;
            margin: 4px 0;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #chat-list li::before {
            content: "üí¨";
        }

        #chat-list li:hover {
            background: #e8eaed;
        }

        #chat-list li.active {
            background: var(--user-msg-bg);
            font-weight: 500;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: var(--radius);
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            align-self: flex-end;
            background: var(--user-msg-bg);
            border-top-right-radius: 0;
        }

        .message-bot {
            align-self: flex-start;
            background: var(--bot-msg-bg);
            border-top-left-radius: 0;
        }

        .message-time {
            font-size: 12px;
            color: #5f6368;
            margin-top: 4px;
            text-align: right;
        }

        .typing-indicator {
            display: flex;
            padding: 12px 16px;
            background: var(--bot-msg-bg);
            border-radius: var(--radius);
            width: fit-content;
            margin-bottom: 12px;
            border-top-left-radius: 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #5f6368;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            text-align: center;
            padding: var(--spacing);
        }

        .empty-state img {
            width: 120px;
            margin-bottom: var(--spacing);
            opacity: 0.6;
        }

        #message-box.hidden {
            display: none;
        }

    </style>
</head>
<body>
<div id="sidebar">
    <div id="sidebar-header">
        <button onclick="createNewChat()" style="width: 100%">+ –ù–æ–≤—ã–π —á–∞—Ç</button>
    </div>
    <ul id="chat-list">
        {% for chat_id, chat in chats.items() %}
        <li data-chat-id="{{ chat_id }}" onclick="selectChat('{{ chat_id }}')">
            {{ chat['chat_name'] }}
        </li>
        {% endfor %}
    </ul>
</div>

<div id="chat-container">
    <div id="chat-header">
        <h2>–ß–∞—Ç —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</h2>
    </div>
    <div id="chat-content">
        <div class="empty-state">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="–ß–∞—Ç">
            <h3>–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π</p>
            <button onclick="createNewChat()" class="secondary" style="margin-top: 16px;">–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
        </div>
    </div>
    <div id="message-box" class="hidden">
        <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onkeydown="handleKeyPress(event)">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    let currentChat = null;
    let isBotTyping = false;

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    const formatTime = (date = new Date()) => {
        return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    };

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const createMessageElement = (role, content) => {
        const messageElement = document.createElement('div');
        messageElement.className = `message message-${role}`;

        const contentElement = document.createElement('div');
        contentElement.innerHTML = content;

        const timeElement = document.createElement('div');
        timeElement.className = 'message-time';
        timeElement.textContent = formatTime();

        messageElement.appendChild(contentElement);
        messageElement.appendChild(timeElement);

        return messageElement;
    };

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const showTypingIndicator = () => {
        if (isBotTyping) return;

        const chatContent = document.getElementById('chat-content');
        const typingElement = document.createElement('div');
        typingElement.className = 'typing-indicator';

        for (let i = 0; i < 3; i++) {
            const dot = document.createElement('div');
            dot.className = 'typing-dot';
            typingElement.appendChild(dot);
        }

        chatContent.appendChild(typingElement);
        chatContent.scrollTop = chatContent.scrollHeight;
        isBotTyping = true;

        return typingElement;
    };

    // –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞
    const hideTypingIndicator = (typingElement) => {
        if (!typingElement) return;
        typingElement.remove();
        isBotTyping = false;
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
    const loadChatMessages = async () => {
        if (!currentChat) return;

        try {
            const response = await fetch(`/chat/${currentChat}`);
            const {messages} = await response.json();
            const chatContent = document.getElementById('chat-content');

            chatContent.innerHTML = '';

            if (messages.length === 0) {
                chatContent.innerHTML = `
                        <div class="empty-state">
                            <h3>–ß–∞—Ç –ø—É—Å—Ç</h3>
                            <p>–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                        </div>
                    `;
                return;
            }

            messages.forEach(msg => {
                chatContent.appendChild(createMessageElement(msg.role, msg.content));
            });

            chatContent.scrollTop = chatContent.scrollHeight;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    const sendMessage = async () => {
        const messageInput = document.getElementById('message');
        const message = messageInput.value.trim();
        if (!message) return;

        const chatContent = document.getElementById('chat-content');
        const currentChatId = currentChat; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π chat_id

        // –ï—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –∏ —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!currentChatId) {
            // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞)
            return;
        }

        try {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            chatContent.appendChild(createMessageElement('user', message));
            chatContent.scrollTop = chatContent.scrollHeight;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
            const typingElement = showTypingIndicator();

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';

            const response = await fetch(`/chat/${currentChatId}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message})
            });

            const {response: botResponse} = await response.json();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª —á–∞—Ç –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
            if (currentChat !== currentChatId) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏–ª —á–∞—Ç, –æ—Ç–≤–µ—Ç –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
                return;
            }

            hideTypingIndicator(typingElement);
            chatContent.appendChild(createMessageElement('bot', botResponse));
            chatContent.scrollTop = chatContent.scrollHeight;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            hideTypingIndicator(typingElement);
            chatContent.appendChild(createMessageElement('bot', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'));
            chatContent.scrollTop = chatContent.scrollHeight;
        }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
    const handleKeyPress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
    const createNewChat = async (firstMessage) => {
        try {
            const response = await fetch('/new_chat', {method: 'POST'});
            const {chat_id} = await response.json();

            currentChat = chat_id;
            const chatList = document.getElementById('chat-list');

            const newChatItem = document.createElement('li');
            newChatItem.textContent = `–ß–∞—Ç ${chatList.children.length + 1}`;
            newChatItem.setAttribute('data-chat-id', chat_id);
            newChatItem.onclick = () => selectChat(chat_id);
            chatList.insertBefore(newChatItem, chatList.firstChild);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-box').classList.remove('hidden');
            selectChat(chat_id);

            if (firstMessage) await sendMessage();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
        }
    };

    // –í—ã–±–æ—Ä —á–∞—Ç–∞
    const selectChat = (chatId) => {
        currentChat = chatId;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('message-box').classList.remove('hidden');

        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö —á–∞—Ç–æ–≤
        document.querySelectorAll('#chat-list li').forEach(li => {
            li.classList.remove('active-chat');
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
        const activeChatItem = Array.from(document.querySelectorAll('#chat-list li'))
            .find(li => li.getAttribute('data-chat-id') === chatId);

        if (activeChatItem) {
            activeChatItem.classList.add('active-chat');
        }

        loadChatMessages();
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = () => {
        const chatList = document.getElementById('chat-list');
        const chats = Array.from(chatList.children);

        chatList.innerHTML = '';
        chats.reverse().forEach(chat => {
            chatList.appendChild(chat);
        });

        if (currentChat) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-box').classList.remove('hidden');
            selectChat(currentChat);
            loadChatMessages();
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ - —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-box').classList.add('hidden');
        }
    };
</script>
</body>
</html>